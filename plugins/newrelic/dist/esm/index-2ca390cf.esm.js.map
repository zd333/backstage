{"version":3,"file":"index-2ca390cf.esm.js","sources":["../../src/api/index.ts","../../src/components/NewRelicFetchComponent/NewRelicFetchComponent.tsx","../../src/components/NewRelicComponent/NewRelicComponent.tsx","../../src/plugin.ts"],"sourcesContent":["/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { createApiRef, DiscoveryApi, IdentityApi } from '@backstage/core';\n\nexport type NewRelicApplication = {\n  id: number;\n  application_summary: NewRelicApplicationSummary;\n  name: string;\n  language: string;\n  health_status: string;\n  reporting: boolean;\n  settings: NewRelicApplicationSettings;\n  links?: NewRelicApplicationLinks;\n};\n\nexport type NewRelicApplicationSummary = {\n  apdex_score: number;\n  error_rate: number;\n  host_count: number;\n  instance_count: number;\n  response_time: number;\n  throughput: number;\n};\n\nexport type NewRelicApplicationSettings = {\n  app_apdex_threshold: number;\n  end_user_apdex_threshold: number;\n  enable_real_user_monitoring: boolean;\n  use_server_side_config: boolean;\n};\n\nexport type NewRelicApplicationLinks = {\n  application_instances: Array<any>;\n  servers: Array<any>;\n  application_hosts: Array<any>;\n};\n\nexport type NewRelicApplications = {\n  applications: NewRelicApplication[];\n};\n\nexport const newRelicApiRef = createApiRef<NewRelicApi>({\n  id: 'plugin.newrelic.service',\n  description: 'Used by the NewRelic plugin to make requests',\n});\n\nconst DEFAULT_PROXY_PATH_BASE = '/newrelic';\n\ntype Options = {\n  discoveryApi: DiscoveryApi;\n  identityApi: IdentityApi;\n  /**\n   * Path to use for requests via the proxy, defaults to /newrelic\n   */\n  proxyPathBase?: string;\n};\n\nexport interface NewRelicApi {\n  getApplications(): Promise<NewRelicApplications>;\n}\n\nexport class NewRelicClient implements NewRelicApi {\n  private readonly discoveryApi: DiscoveryApi;\n  private readonly identityApi: IdentityApi;\n\n  private readonly proxyPathBase: string;\n\n  constructor(options: Options) {\n    this.discoveryApi = options.discoveryApi;\n    this.identityApi = options.identityApi;\n    this.proxyPathBase = options.proxyPathBase ?? DEFAULT_PROXY_PATH_BASE;\n  }\n\n  async getApplications(): Promise<NewRelicApplications> {\n    const url = await this.getApiUrl('apm', 'applications.json');\n    const token = await this.identityApi.getIdToken();\n\n    const response = await fetch(url, {\n      headers: token ? { Authorization: `Bearer ${token}` } : {},\n    });\n    let responseJson;\n\n    try {\n      responseJson = await response.json();\n    } catch (e) {\n      responseJson = { applications: [] };\n    }\n\n    if (response.status !== 200) {\n      throw new Error(\n        `Error communicating with New Relic: ${\n          responseJson?.error?.title || response.statusText\n        }`,\n      );\n    }\n\n    return responseJson;\n  }\n\n  private async getApiUrl(product: string, path: string) {\n    const proxyUrl = await this.discoveryApi.getBaseUrl('proxy');\n    return `${proxyUrl}${this.proxyPathBase}/${product}/api/${path}`;\n  }\n}\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from 'react';\nimport { Progress, Table, TableColumn, useApi } from '@backstage/core';\nimport Alert from '@material-ui/lab/Alert';\nimport { useAsync } from 'react-use';\nimport { newRelicApiRef, NewRelicApplications } from '../../api';\n\nexport const NewRelicAPMTable = ({ applications }: NewRelicApplications) => {\n  const columns: TableColumn[] = [\n    { title: 'Application', field: 'name' },\n    { title: 'Response Time', field: 'responseTime' },\n    { title: 'Throughput', field: 'throughput' },\n    { title: 'Error Rate', field: 'errorRate' },\n    { title: 'Instance Count', field: 'instanceCount' },\n    { title: 'Apdex', field: 'apdexScore' },\n  ];\n  const data = applications.map(app => {\n    const { name, application_summary: applicationSummary } = app;\n    const {\n      response_time: responseTime,\n      throughput,\n      error_rate: errorRate,\n      instance_count: instanceCount,\n      apdex_score: apdexScore,\n    } = applicationSummary;\n\n    return {\n      name,\n      responseTime: `${responseTime} ms`,\n      throughput: `${throughput} rpm`,\n      errorRate: `${errorRate}%`,\n      instanceCount,\n      apdexScore,\n    };\n  });\n\n  return (\n    <Table\n      title=\"Application Performance Monitoring\"\n      options={{ search: false, paging: false }}\n      columns={columns}\n      data={data}\n    />\n  );\n};\n\nconst NewRelicFetchComponent = () => {\n  const api = useApi(newRelicApiRef);\n\n  const { value, loading, error } = useAsync(async () => {\n    const data = await api.getApplications();\n    return data.applications.filter(application => {\n      return application.hasOwnProperty('application_summary');\n    });\n  }, []);\n\n  if (loading) {\n    return <Progress />;\n  } else if (error) {\n    return <Alert severity=\"error\">{error.message}</Alert>;\n  }\n\n  return <NewRelicAPMTable applications={value || []} />;\n};\n\nexport default NewRelicFetchComponent;\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from 'react';\nimport { Grid } from '@material-ui/core';\nimport {\n  Header,\n  Page,\n  Content,\n  ContentHeader,\n  HeaderLabel,\n  SupportButton,\n} from '@backstage/core';\nimport NewRelicFetchComponent from '../NewRelicFetchComponent';\n\nconst NewRelicComponent = () => (\n  <Page themeId=\"tool\">\n    <Header title=\"New Relic\">\n      <HeaderLabel label=\"Owner\" value=\"Engineering\" />\n    </Header>\n    <Content>\n      <ContentHeader title=\"New Relic\">\n        <SupportButton>\n          New Relic Application Performance Monitoring\n        </SupportButton>\n      </ContentHeader>\n      <Grid container spacing={3} direction=\"column\">\n        <Grid item>\n          <NewRelicFetchComponent />\n        </Grid>\n      </Grid>\n    </Content>\n  </Page>\n);\n\nexport default NewRelicComponent;\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  createApiFactory,\n  createPlugin,\n  createRouteRef,\n  discoveryApiRef,\n  createRoutableExtension,\n  identityApiRef,\n} from '@backstage/core';\nimport { NewRelicClient, newRelicApiRef } from './api';\nimport NewRelicComponent from './components/NewRelicComponent';\n\nexport const rootRouteRef = createRouteRef({\n  path: '/newrelic',\n  title: 'newrelic',\n});\n\nexport const newRelicPlugin = createPlugin({\n  id: 'newrelic',\n  apis: [\n    createApiFactory({\n      api: newRelicApiRef,\n      deps: { discoveryApi: discoveryApiRef, identityApi: identityApiRef },\n      factory: ({ discoveryApi, identityApi }) =>\n        new NewRelicClient({ discoveryApi, identityApi }),\n    }),\n  ],\n  register({ router }) {\n    router.addRoute(rootRouteRef, NewRelicComponent);\n  },\n  routes: {\n    root: rootRouteRef,\n  },\n});\n\nexport const NewRelicPage = newRelicPlugin.provide(\n  createRoutableExtension({\n    component: () =>\n      import('./components/NewRelicComponent').then(m => m.default),\n    mountPoint: rootRouteRef,\n  }),\n);\n"],"names":[],"mappings":";;;;;;MAuDa,iBAAiB,aAA0B;AAAA,EACtD,IAAI;AAAA,EACJ,aAAa;AAAA;AAGf,MAAM,0BAA0B;qBAemB;AAAA,EAMjD,YAAY,SAAkB;AAjFhC;AAkFI,SAAK,eAAe,QAAQ;AAC5B,SAAK,cAAc,QAAQ;AAC3B,SAAK,gBAAgB,cAAQ,kBAAR,YAAyB;AAAA;AAAA,QAG1C,kBAAiD;AAvFzD;AAwFI,UAAM,MAAM,MAAM,KAAK,UAAU,OAAO;AACxC,UAAM,QAAQ,MAAM,KAAK,YAAY;AAErC,UAAM,WAAW,MAAM,MAAM,KAAK;AAAA,MAChC,SAAS,QAAQ,CAAE,eAAe,UAAU,WAAY;AAAA;AAE1D,QAAI;AAEJ,QAAI;AACF,qBAAe,MAAM,SAAS;AAAA,aACvB,GAAP;AACA,qBAAe,CAAE,cAAc;AAAA;AAGjC,QAAI,SAAS,WAAW,KAAK;AAC3B,YAAM,IAAI,MACR,uCACE,oDAAc,UAAd,mBAAqB,UAAS,SAAS;AAAA;AAK7C,WAAO;AAAA;AAAA,QAGK,UAAU,SAAiB,MAAc;AACrD,UAAM,WAAW,MAAM,KAAK,aAAa,WAAW;AACpD,WAAO,GAAG,WAAW,KAAK,iBAAiB,eAAe;AAAA;AAAA;;MC7FjD,mBAAmB,CAAC,CAAE,kBAAyC;AAC1E,QAAM,UAAyB;AAAA,IAC7B,CAAE,OAAO,eAAe,OAAO;AAAA,IAC/B,CAAE,OAAO,iBAAiB,OAAO;AAAA,IACjC,CAAE,OAAO,cAAc,OAAO;AAAA,IAC9B,CAAE,OAAO,cAAc,OAAO;AAAA,IAC9B,CAAE,OAAO,kBAAkB,OAAO;AAAA,IAClC,CAAE,OAAO,SAAS,OAAO;AAAA;AAE3B,QAAM,OAAO,aAAa,IAAI,SAAO;AACnC,UAAM,CAAE,MAAM,qBAAqB,sBAAuB;AAC1D,UAAM;AAAA,MACJ,eAAe;AAAA,MACf;AAAA,MACA,YAAY;AAAA,MACZ,gBAAgB;AAAA,MAChB,aAAa;AAAA,QACX;AAEJ,WAAO;AAAA,MACL;AAAA,MACA,cAAc,GAAG;AAAA,MACjB,YAAY,GAAG;AAAA,MACf,WAAW,GAAG;AAAA,MACd;AAAA,MACA;AAAA;AAAA;AAIJ,6CACG,OAAD;AAAA,IACE,OAAM;AAAA,IACN,SAAS,CAAE,QAAQ,OAAO,QAAQ;AAAA,IAClC;AAAA,IACA;AAAA;AAAA;AAKN,MAAM,yBAAyB,MAAM;AACnC,QAAM,MAAM,OAAO;AAEnB,QAAM,CAAE,OAAO,SAAS,SAAU,SAAS,YAAY;AACrD,UAAM,OAAO,MAAM,IAAI;AACvB,WAAO,KAAK,aAAa,OAAO,iBAAe;AAC7C,aAAO,YAAY,eAAe;AAAA;AAAA,KAEnC;AAEH,MAAI,SAAS;AACX,+CAAQ,UAAD;AAAA,aACE,OAAO;AAChB,+CAAQ,OAAD;AAAA,MAAO,UAAS;AAAA,OAAS,MAAM;AAAA;AAGxC,6CAAQ,kBAAD;AAAA,IAAkB,cAAc,SAAS;AAAA;AAAA;;MCjD5C,oBAAoB,0CACvB,MAAD;AAAA,EAAM,SAAQ;AAAA,uCACX,QAAD;AAAA,EAAQ,OAAM;AAAA,uCACX,aAAD;AAAA,EAAa,OAAM;AAAA,EAAQ,OAAM;AAAA,yCAElC,SAAD,0CACG,eAAD;AAAA,EAAe,OAAM;AAAA,uCAClB,eAAD,MAAe,sFAIhB,MAAD;AAAA,EAAM,WAAS;AAAA,EAAC,SAAS;AAAA,EAAG,WAAU;AAAA,uCACnC,MAAD;AAAA,EAAM,MAAI;AAAA,uCACP,wBAAD;;MCdG,eAAe,eAAe;AAAA,EACzC,MAAM;AAAA,EACN,OAAO;AAAA;MAGI,iBAAiB,aAAa;AAAA,EACzC,IAAI;AAAA,EACJ,MAAM;AAAA,IACJ,iBAAiB;AAAA,MACf,KAAK;AAAA,MACL,MAAM,CAAE,cAAc,iBAAiB,aAAa;AAAA,MACpD,SAAS,CAAC,CAAE,cAAc,iBACxB,IAAI,eAAe,CAAE,cAAc;AAAA;AAAA;AAAA,EAGzC,SAAS,CAAE,SAAU;AACnB,WAAO,SAAS,cAAc;AAAA;AAAA,EAEhC,QAAQ;AAAA,IACN,MAAM;AAAA;AAAA;MAIG,eAAe,eAAe,QACzC,wBAAwB;AAAA,EACtB,WAAW,MACF,kCAAkC,KAAK,OAAK,EAAE;AAAA,EACvD,YAAY;AAAA;;;;"}